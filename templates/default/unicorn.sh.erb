#!/bin/sh
### BEGIN INIT INFO
# Provides:          unicorn
# Required-Start:    $remote_fs $syslog
# Required-Stop:     $remote_fs $syslog
# Default-Start:     2 3 4 5
# Default-Stop:      0 1 6
# Short-Description: HTTP server for Rack applications
# Description:       HTTP server for Rack applications
### END INIT INFO

set -e

PATH=/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin

DEPLOY_ROOT="<%= @deploy_root %>"
PID_FILE="$DEPLOY_ROOT/tmp/pids/unicorn.pid"
: ${RAILS_ENV:="production"}

config_path() {
    if [ -e "$DEPLOY_ROOT/config/unicorn.rb" ]; then
        config_path="$DEPLOY_ROOT/config/unicorn.rb"
    else
        if [ -e "$DEPLOY_ROOT/config/unicorn/${RAILS_ENV}.rb" ]; then
            config_path="$DEPLOY_ROOT/config/unicorn/${RAILS_ENV}.rb"
        else
            echo >&2 "Config file for $RAILS_ENV environment was not found"
            exit 1
        fi
    fi
    echo "$config_path"
}

start() {
    if [ -e "$PID_FILE" ]; then
        if  kill -0 `cat "$PID_FILE"` >/dev/null 2>&1; then
            echo "Unicorn is already running!"
            exit 0
        fi
        rm "$PID_FILE"
    fi

    echo "Starting Unicorn..."
    cd "$DEPLOY_ROOT" && BUNDLE_GEMFILE="$DEPLOY_ROOT/Gemfile" \
        bundle exec unicorn -c "$(config_path)" -E "$RAILS_ENV" -D
}

stop() {
    if [ -e "$PID_FILE" ] && kill -0 `cat "$PID_FILE"` >/dev/null 2>&1; then
        echo "Stopping Unicorn..."
        kill -s QUIT `cat "$PID_FILE"`
    else
        echo "Unicorn is not running."
    fi
}

case "$1" in
    start)
        start
        ;;
    stop)
        stop
        ;;
    *)
        echo >&2 "Usage: $0 [start|stop]"
        exit 1
        ;;
esac
